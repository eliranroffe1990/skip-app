<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SKIPAPP - משחק החיסכון</title>
  <meta name="theme-color" content="#0F766E"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="apple-touch-icon" href="/icons/icon-180.png"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="SKIPAPP"/>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;800&family=Poppins:wght@300;400;700&display=swap" rel="stylesheet"/>
  <style>
    :root{--emerald:#0F766E; --coral:#FF9E7D; --sand:#F9F5EB; --ink:#1F2937; --muted:#6B7280; --border:#EAEAEA; --card:#FFFFFF}
    *{box-sizing:border-box}
    html{font-size:17px}
    body{margin:0;color:var(--ink);font-family:'Heebo','Poppins',system-ui; background:
      radial-gradient(120% 140% at 0% 0%, rgba(47,170,160,.25) 0%, var(--sand) 40%),
      linear-gradient(135deg, rgba(15,118,110,.14), rgba(255,158,125,.12));}
    header{background:linear-gradient(135deg,var(--emerald),var(--coral));color:#fff;padding:14px 18px; position:sticky; top:0; z-index:9}
    .wrap{max-width:860px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:18px;padding:22px;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .hint{color:var(--muted);font-size:.95rem}
    .btn{appearance:none;border:none;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;min-height:44px}
    .btn-primary{background:linear-gradient(135deg,var(--emerald),var(--coral)); color:#fff}
    .btn-outline{background:#fff;border:2px solid var(--border);color:var(--ink)}
    .topbar{display:flex;align-items:center;gap:8px}
    .brand{font-weight:800;margin:0}
    .motto{font-size:.85rem;color:#fff;opacity:.9;margin:2px 0 0}
    .navicons{margin-inline-start:auto;display:flex;gap:8px}
    .iconbtn{background:rgba(255,255,255,.15);border:none;border-radius:10px;padding:8px;cursor:pointer}
    .iconbtn svg{width:24px;height:24px;fill:#fff}
    .qnav{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:0 0 12px}
    .tile{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;text-align:center;font-weight:700;color:var(--emerald);
           box-shadow:0 6px 22px rgba(0,0,0,.05);cursor:pointer}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.06);border:1px solid var(--border)}
    thead th{background:linear-gradient(135deg,#e8f4f2,#fff);color:#445;font-weight:800;padding:12px;border-bottom:1px solid var(--border)}
    tbody td{padding:12px;border-bottom:1px solid #f1f1f1;font-size:.95rem}
    tbody tr:hover{background:#fafafa}
    .chartWrap{background:#fff;border-radius:16px;padding:12px;border:1px solid var(--border);box-shadow:0 8px 30px rgba(0,0,0,.06)}
    .chartTitle{font-weight:700;margin:0 0 6px;color:#3b3b3b}
    canvas{width:100%;height:200px}
  </style>
</head>
<body>
  <header>
    <div class="topbar wrap">
      <button class="iconbtn" onclick="App.goBack()" title="חזרה">↩</button>
      <h1 class="brand">SKIPAPP</h1>
      <p class="motto">דלג על הוצאה – חסוך לעתיד</p>
      <!-- Home icon -->
      <button class="iconbtn" onclick="App.goHome()" title="מסך הבית">
        <svg viewBox="0 0 24 24"><path d="M12 3l9 8h-3v9h-4v-6H10v6H6v-9H3z"/></svg>
      </button>
    </div>
  </header>

  <main id="app" class="wrap"></main>

  <script>
  const LAST_UPDATED='2025-12-09';
  const strings={he:{
    back:'חזרה', home:'בית',
    terms_title:'תנאי שימוש והצהרת אחריות',
    terms_text:'האפליקציה מיועדת ללמידה בלבד ואינה ייעוץ פיננסי. שימוש באפליקציה באחריות המשתמש.',
    accept_terms:'אני מסכים לתנאים', continue:'המשך',
    register_title:'הרשמה', name:'שם', age:'גיל', goal:'מטרת חיסכון חודשית (₪)', start_saving:'התחל לחסוך!',
    dashboard_title:'בחר מה תרצה לעשות', add_skip:'הוסף דילוג', history:'היסטוריה', insights:'תובנות', investments:'אפיקי השקעה', settings:'הגדרות',
    amount:'סכום (₪)', description:'תיאור', category:'קטגוריה', save:'שמור', reset_all:'איפוס והרשמה מחדש', installed_hint:'להתקנה בנייד: תפריט הדפדפן → הוסף למסך הבית',
    invest_title:'אפיקי השקעה מוצעים', invest_intro:'חיסכון עקבי היום מייצר לך אפשרות השקעה חכמה מחר. בחר/י אפיק מתאים והמשך/י לבנות את העתיד הפיננסי שלך.', invest_disclaimer:'המידע להדגמה בלבד, אינו ייעוץ פיננסי.',
    summary_title:'סיכום', summary_about:'SKIPAPP מסייעת להפוך דילוגים קטנים לחיסכון מודע.', go_home:'חזרה לדף הבית', last_updated:'עדכון אחרון',
    export_csv:'ייצוא לאקסל (CSV)'
  }};

  function formatDate(iso){ try{const d=new Date(iso); if(isNaN(d)) return '—'; return d.toLocaleString('he-IL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{return '—';}}
  function prepCanvas(canvas,h=200){const dpr=window.devicePixelRatio||1;const w=canvas.clientWidth,hpx=h;canvas.width=Math.max(1,w*dpr);canvas.height=Math.max(1,hpx*dpr);const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);return ctx;}
  function drawSavingsLine(canvas,data){ if(!canvas) return; const ctx=prepCanvas(canvas,200); const w=canvas.clientWidth,h=200,pad=24; const days={}; (data||[]).forEach(x=>{const d=new Date(x.date); if(isNaN(d)) return; const key=d.toISOString().slice(0,10); days[key]=(days[key]||0)+(x.amount||0);}); const keys=Object.keys(days).sort(); const series=[]; let acc=0; keys.forEach(k=>{acc+=days[k]; series.push({label:k,value:acc});}); if(series.length===0){series.push({label:formatDate(new Date().toISOString()),value:0});} const maxV=Math.max(...series.map(s=>s.value),1); ctx.clearRect(0,0,w,h); ctx.strokeStyle='#e9e9e9'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke(); ctx.strokeStyle='#0F766E'; ctx.lineWidth=2; ctx.beginPath(); series.forEach((s,i)=>{const x=pad+i*((w-2*pad)/Math.max(1,series.length-1)); const y=h-pad-(s.value/maxV)*(h-2*pad); i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}); ctx.stroke();}
  function drawMonthlyBars(canvas,data){ if(!canvas) return; const ctx=prepCanvas(canvas,200); const w=canvas.clientWidth,h=200,pad=24; const months={}; (data||[]).forEach(x=>{const d=new Date(x.date); if(isNaN(d)) return; const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); months[key]=(months[key]||0)+(x.amount||0);}); const keys=Object.keys(months).sort(); if(keys.length===0){keys.push('—'); months['—']=0;} const values=keys.map(k=>months[k]); const maxV=Math.max(...values,1); const barW=(w-2*pad)/keys.length*0.6; keys.forEach((k,i)=>{const v=months[k]; const x=pad+i*((w-2*pad)/keys.length)+((w-2*pad)/keys.length-barW)/2; const barH=(v/maxV)*(h-2*pad); const y=h-pad-barH; ctx.fillStyle='#FF9E7D'; ctx.fillRect(x,y,barW,barH); ctx.strokeStyle='#e4e4e4'; ctx.strokeRect(x,y,barW,barH);});}

  function openLink(url){ const isiOSStandalone = window.navigator.standalone || (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches); if(isiOSStandalone) location.href=url; else window.open(url,'_blank','noopener,noreferrer'); }

  const App={ state:{screen:'dashboard',history:[],user:null,lang:'he',data:[]},
    t(k){return strings[this.state.lang][k]||k},
    push(s){this.state.history.push(this.state.screen);this.state.screen=s;this.render();},
    goBack(){ if(this.state.history.length){this.state.screen=this.state.history.pop(); this.render();} else { this.goHome(); } },
    goHome(){ this.state.screen='dashboard'; this.render(); },
    saveUser(u){ localStorage.setItem('skipapp_user',JSON.stringify(u)); this.state.user=u; },
    saveData(){ localStorage.setItem('skipapp_data',JSON.stringify(this.state.data)); },
    addSkip(item){ this.state.data.push(item); this.saveData(); this.goHome(); },
    reset(){ localStorage.removeItem('skipapp_user'); localStorage.removeItem('skipapp_data'); localStorage.removeItem('skipapp_terms'); this.state={screen:'terms',history:[],user:null,lang:(localStorage.getItem('skipapp_lang')||'he'),data:[]}; this.render(); },
    load(){ const u=localStorage.getItem('skipapp_user'); if(u) this.state.user=JSON.parse(u); const d=localStorage.getItem('skipapp_data'); if(d) this.state.data=JSON.parse(d); this.render(); },
    investments(){ return [
      {key:'ibi',name:'IBI Investment House',url:'https://www.ibi.co.il/en/'},
      {key:'meitav',name:'Meitav',url:'https://www.meitav.co.il/en/'},
      {key:'harel',name:'Harel Group (IR)',url:'https://pr.harel-group.co.il/'},
      {key:'psagot',name:'Psagot Trade',url:'https://www.psagotrade.com/en/'},
      {key:'altshuler',name:'Altshuler Shaham',url:'https://www.as-invest.co.il/en/'},
      {key:'phoenix',name:'Phoenix Financial (IR)',url:'https://www.fnx.co.il/en/investor-relations/'},
      {key:'etoro',name:'eToro',url:'https://www.etoro.com/'},
      {key:'ibkr',name:'Interactive Brokers',url:'https://www.interactivebrokers.com/'},
      {key:'clal',name:'Clal Insurance & Finance',url:'https://www.clalbit.co.il/investorsrelations/aboutclalinsurance/'},
      {key:'more',name:'More Invest',url:'https://www.moreinvest.co.il/'}
    ].sort((a,b)=>a.name.localeCompare(b.name)); },

    qnavHTML(){ const L=(k)=>this.t(k); return `
      <div class="qnav">
        <div class="tile" onclick="App.push('addSkip')">${L('add_skip')}</div>
        <div class="tile" onclick="App.push('history')">${L('history')}</div>
        <div class="tile" onclick="App.push('insights')">${L('insights')}</div>
        <div class="tile" onclick="App.push('investments')">${L('investments')}</div>
        <div class="tile" onclick="App.push('settings')">${L('settings')}</div>
      </div>`; },

    exportCSV(){ const rows=(this.state.data||[]).slice().reverse(); const header=['תאריך','סכום','קטגוריה','תיאור']; const lines=[header.join(',')]; rows.forEach(r=>{ lines.push([formatDate(r.date),(r.amount||0),`"${r.category||''}"`,`"${(r.description||'').replace(/"/g,'\"')}"`].join(',')); }); const blob=new Blob(["\ufeff"+lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='skipapp_history.csv'; a.click(); URL.revokeObjectURL(a.href); },

    render(){ const el=document.getElementById('app'); const L=(k)=>this.t(k); let html=''; const total=this.state.data.reduce((s,x)=>s+(x.amount||0),0); // FULL VALUE

      if(this.state.screen==='dashboard'){
        html = `
        <section>
          <div class="card">
            <h2>${L('dashboard_title')}</h2>
            ${this.qnavHTML()}
            <p class="hint">שווי חיסכון מלא עד כה: ₪${total.toFixed(2)}</p>
          </div>
          <div class="chartWrap" style="margin-top:12px">
            <h3 class="chartTitle">חיסכון מצטבר</h3>
            <canvas id="lineDash"></canvas>
          </div>
        </section>`;
        requestAnimationFrame(()=>drawSavingsLine(document.getElementById('lineDash'),this.state.data));
      }

      else if(this.state.screen==='addSkip'){
        html = `
        <section>
          <div class="card">
            <h2>${L('add_skip')}</h2>
            <label class="hint">${L('amount')}</label>
            <input id="amt" type="number" min="1" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;"/>
            <label class="hint" style="margin-top:8px">${L('description')}</label>
            <input id="desc" type="text" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;"/>
            <label class="hint" style="margin-top:8px">${L('category')}</label>
            <select id="cat" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;">
              <option>אוכל ושתייה</option><option>אופנה</option><option>בילויים</option><option>טכנולוגיה</option>
              <option>יופי וטיפוח</option><option>תחבורה</option><option>מנויים</option><option>קניות אימפולסיביות</option>
              <option>חברתי</option><option>אחר</option>
            </select>
            <p class="hint" style="margin-top:10px">כסף שנצבר להשקעות באפיקים המתאימים לך.</p>
            <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
              <button class="btn btn-primary" onclick="(function(){ const item={ amount:parseFloat(document.getElementById('amt').value||0), description:document.getElementById('desc').value.trim(), category:document.getElementById('cat').value, date:new Date().toISOString() }; if(!item.amount||!item.description){ alert('נא להזין סכום ותיאור'); return;} App.addSkip(item); })()">${L('save')}</button>
              <button class="btn btn-outline" onclick="App.goHome()">${L('home')}</button>
            </div>
          </div>
          <div class="card" style="margin-top:12px">${this.qnavHTML()}</div>
        </section>`;
      }

      else if(this.state.screen==='history'){
        const rows=(this.state.data||[]).slice().reverse();
        html = `
        <section>
          <div class="card">
            <h2>${L('history')}</h2>
            ${this.qnavHTML()}
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button class="btn btn-outline" onclick="App.exportCSV()">${L('export_csv')}</button>
              <button class="btn btn-outline" onclick="App.goHome()">${L('home')}</button>
            </div>
          </div>
          <div style="margin-top:10px">
            <table>
              <thead><tr><th>תאריך</th><th>סכום (₪)</th><th>קטגוריה</th><th>תיאור</th></tr></thead>
              <tbody>
                ${ rows.length ? rows.map(s=>`<tr><td>${formatDate(s.date)}</td><td>${(s.amount||0).toFixed(2)}</td><td>${s.category||'-'}</td><td>${s.description||'-'}</td></tr>`).join('') : `<tr><td colspan="4" class="hint">אין רישומים עדיין</td></tr>` }
              </tbody>
            </table>
          </div>
        </section>`;
      }

      else if(this.state.screen==='insights'){
        const goal = this.state.user?.goal || 1000;
        const canInvest = total > 100; // rule
        const msg = canInvest ? 'כבר ניתן להתחיל לחסוך ולהשקיע.' : 'המשיכו בדילוגים קטנים כדי להגיע ליעד ולהתחיל להשקיע.';
        html = `
        <section>
          <div class="card">
            <h2>${L('insights')}</h2>
            ${this.qnavHTML()}
            <p class="hint">שווי חיסכון מלא: ₪${total.toFixed(2)}</p>
            <p class="hint">${msg}</p>
            <div class="chartWrap" style="margin-top:10px">
              <h3 class="chartTitle">חיסכון מצטבר</h3>
              <canvas id="lineInsights"></canvas>
            </div>
            <button class="btn btn-outline" style="margin-top:10px" onclick="App.goHome()">${L('home')}</button>
          </div>
        </section>`;
        requestAnimationFrame(()=>drawSavingsLine(document.getElementById('lineInsights'),this.state.data));
      }

      else if(this.state.screen==='investments'){
        const items=this.investments();
        html = `
        <section>
          <div class="card">
            <h2>${L('invest_title')}</h2>
            <p class="hint" style="margin-bottom:8px">${L('invest_intro')}</p>
            <p class="hint">${L('invest_disclaimer')}</p>
            ${this.qnavHTML()}
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:10px">
              ${items.map(i=>`<div class="tile" onclick="openLink('${i.url}')">${i.name}</div>`).join('')}
            </div>
            <button class="btn btn-outline" style="margin-top:10px" onclick="App.goHome()">${L('home')}</button>
          </div>
        </section>`;
      }

      else if(this.state.screen==='settings'){
        const u=this.state.user||{firstName:'',age:'',goal:''};
        html = `
        <section>
          <div class="card">
            <h2>${L('settings')}</h2>
            ${this.qnavHTML()}
            <p class="hint">שם: ${u.firstName||'-'} • גיל: ${u.age||'-'} • יעד חודשי: ₪${u.goal||'-'}</p>
            <p class="hint">${strings.he.last_updated}: ${formatDate(LAST_UPDATED)}</p>
            <details style="margin-top:8px"><summary class="hint">${strings.he.terms_title}</summary><p class="hint">${strings.he.terms_text}</p></details>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <button class="btn btn-outline" onclick="App.reset()">${L('reset_all')}</button>
              <button class="btn btn-outline" onclick="App.goHome()">${L('home')}</button>
            </div>
          </div>
        </section>`;
      }

      el.innerHTML = html;
    }
  };

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }
  App.load();
  </script>
</body>
</html>
